<!DOCTYPE html>
<html>
<head>
    <title>Vino Bingo - Referral</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="telegram:viewport" content="width=device-width, initial-scale=1.0">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        :root {
            --primary: #4CAF50;
            --secondary: #2196F3;
            --accent: #FFD700;
            --dark: #0f1a2a;
            --light: #f8f9fa;
            --background: #1a2a3a;
            --telegram: #0088cc;
            --whatsapp: #25D366;
            --facebook: #3b5998;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Poppins', sans-serif;
            max-width: 100%;
            margin: 0 auto;
            padding: 15px;
            background-color: var(--background);
            color: var(--light);
            min-height: 100vh;
            touch-action: manipulation;
        }
        .back-btn {
            position: absolute;
            top: 15px;
            left: 15px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--light);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 10;
        }
        .back-btn:active { transform: scale(0.95); }
        .referral-container { animation: fadeInUp 0.8s ease; }
        .referral-header { text-align: center; margin-bottom: 20px; }
        .referral-header h1 {
            font-size: 1.6rem;
            margin-bottom: 8px;
            color: var(--accent);
        }
        .referral-header p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }
        .stats-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }
        .stat-box {
            text-align: center;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(5px);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            animation: pulse 2s infinite alternate;
        }
        .stat-number {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 5px;
        }
        .stat-label { font-size: 0.8rem; color: rgba(255, 255, 255, 0.7); }
        .referral-link-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(5px);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .referral-link-title {
            font-size: 1rem;
            margin-bottom: 10px;
            color: var(--accent);
        }
        .referral-link {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 8px;
            word-break: break-all;
            font-family: monospace;
            margin-bottom: 15px;
        }
        .copy-btn {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            width: 100%;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .copy-btn:active { transform: scale(0.98); }
        .share-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        .share-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .share-btn:active { transform: scale(0.95); }
        .telegram { background: var(--telegram); }
        .whatsapp { background: var(--whatsapp); }
        .facebook { background: var(--facebook); }
        .program-details {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(5px);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .program-details h2 {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: var(--accent);
        }
        .program-details ol { padding-left: 20px; }
        .program-details li { margin-bottom: 10px; }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.03); } }
        @media (max-height: 600px) {
            .stat-box { padding: 12px; }
            .share-btn { width: 45px; height: 45px; font-size: 1.3rem; }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <button class="back-btn" onclick="window.location.href='index.html'">
        <i class="fas fa-arrow-left"></i>
    </button>
    <div class="referral-container">
        <div class="referral-header">
            <h1>Invite Friends & Earn</h1>
            <p>Get 20 points for every friend who joins and deposits!</p>
        </div>
        <div class="stats-container">
            <div class="stat-box">
                <div class="stat-number" id="referralCount">-</div>
                <div class="stat-label">Referrals</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="pointsEarned">-</div>
                <div class="stat-label">Points Earned</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="activeReferrals">-</div>
                <div class="stat-label">Active Players</div>
            </div>
            <div class="stat-box">
                <div class="stat-number">Soon</div>
                <div class="stat-label">Birr Value</div>
            </div>
        </div>
        <div class="referral-link-container">
            <div class="referral-link-title">Your referral link:</div>
            <div class="referral-link" id="referralLink">
                Loading...
            </div>
            <button class="copy-btn" onclick="copyReferralLink()">
                <i class="fas fa-copy"></i> Copy Link
            </button>
        </div>
        <div class="share-buttons">
            <div class="share-btn telegram" onclick="share('telegram')">
                <i class="fab fa-telegram"></i>
            </div>
            <div class="share-btn whatsapp" onclick="share('whatsapp')">
                <i class="fab fa-whatsapp"></i>
            </div>
            <div class="share-btn facebook" onclick="share('facebook')">
                <i class="fab fa-facebook-f"></i>
            </div>
        </div>
        <div class="program-details">
            <h2><i class="fas fa-gift"></i> How it works:</h2>
            <ol>
                <li>Share your unique link with friends</li>
                <li>They must register using your link</li>
                <li>You earn <strong>20 points</strong> when they deposit for the first time</li>
                <li>Redeem points for <strong>1 Birr = 2 points</strong></li>
                <li>No limit on how many friends you can refer!</li>
            </ol>
        </div>
    </div>
    <script>
        const API_BASE = "https://vinobingo-backend.onrender.com/api";
        let referralLink = "";
        let telegramId = "";

        function getTelegramId() {
            // Try to get from Telegram WebApp, fallback to localStorage or generate
            try {
                if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) {
                    telegramId = Telegram.WebApp.initDataUnsafe.user.id.toString();
                } else {
                    telegramId = localStorage.getItem('telegramId');
                    if (!telegramId) {
                        telegramId = Math.floor(Math.random() * 1e8).toString();
                        localStorage.setItem('telegramId', telegramId);
                    }
                }
            } catch (e) {
                telegramId = localStorage.getItem('telegramId') || Math.floor(Math.random() * 1e8).toString();
                localStorage.setItem('telegramId', telegramId);
            }
        }

        async function loadReferralStats() {
            getTelegramId();
            referralLink = `https://t.me/VinoBingoBot?start=ref-${telegramId}`;
            document.getElementById('referralLink').textContent = referralLink;

            // Fetch referral info from backend
            try {
                const res = await fetch(`${API_BASE}/users/referral-stats?telegramId=${telegramId}`);
                const data = await res.json();
                document.getElementById('referralCount').textContent = data.totalReferrals ?? 0;
                document.getElementById('activeReferrals').textContent = data.activeReferrals ?? 0;
                document.getElementById('pointsEarned').textContent = (data.activeReferrals ? data.activeReferrals * 20 : 0);
            } catch (e) {
                document.getElementById('referralCount').textContent = "-";
                document.getElementById('activeReferrals').textContent = "-";
                document.getElementById('pointsEarned').textContent = "-";
            }
        }

        function copyReferralLink() {
            navigator.clipboard.writeText(referralLink).then(() => {
                alert("Referral link copied to clipboard!");
                if ('vibrate' in navigator) navigator.vibrate(100);
            });
        }

        function share(platform) {
            const message = `Join Vino Bingo with my link and we both win! ${referralLink}`;
            let url;
            switch(platform) {
                case 'telegram':
                    url = `https://t.me/share/url?url=${encodeURIComponent(referralLink)}&text=${encodeURIComponent("Let's play Vino Bingo together!")}`;
                    break;
                case 'whatsapp':
                    url = `https://wa.me/?text=${encodeURIComponent(message)}`;
                    break;
                case 'facebook':
                    url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(referralLink)}`;
                    break;
            }
            if ('vibrate' in navigator) navigator.vibrate(50);
            window.open(url, '_blank');
        }

        document.addEventListener('DOMContentLoaded', loadReferralStats);
    </script>
</body>
</html>
